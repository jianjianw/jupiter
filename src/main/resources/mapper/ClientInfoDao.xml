<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiein.jupiter.web.dao.ClientInfoDao">

    <resultMap id="infoMap" type="com.qiein.jupiter.web.entity.dto.ClientPushDTO">
        <id column="ID" jdbcType="INTEGER" property="id"/>
        <result column="KZID" jdbcType="VARCHAR" property="kzId"/>
        <result column="STATUSID" jdbcType="INTEGER" property="statusId"/>
		<result column="COLLECTORID" jdbcType="INTEGER" property="collectorId"/>
        <result column="APPOINTORID" jdbcType="INTEGER" property="appointorId"/>
        <result column="COMPANYID" jdbcType="INTEGER" property="companyId"/>
        <result column="PUSHINTERVAL" jdbcType="INTEGER" property="pushInterval"/>
        <result column="SOURCEID" jdbcType="INTEGER" property="sourceId"/>
        <result column="PUSHRULE" jdbcType="INTEGER" property="pushRule"/>
        <result column="SHOPID" jdbcType="INTEGER" property="shopId"/>
        <result column="TYPEID" jdbcType="INTEGER" property="typeId"/>
        <result column="CHANNELID" jdbcType="INTEGER" property="channelId"/>
        <result column="TYPEID" jdbcType="INTEGER" property="channelTypeId"/>
    </resultMap>

	<resultMap id="goEasyMap" type="com.qiein.jupiter.web.entity.dto.ClientGoEasyDTO">
		<id column="ID" jdbcType="INTEGER" property="id"/>
		<result column="KZID" jdbcType="VARCHAR" property="kzId"/>
		<result column="KZNAME" jdbcType="VARCHAR" property="kzName"/>
		<result column="KZPHONE" jdbcType="VARCHAR" property="kzPhone"/>
		<result column="KZWECHAT" jdbcType="VARCHAR" property="kzWechat"/>
		<result column="KZQQ" jdbcType="VARCHAR" property="kzQq"/>
		<result column="KZWW" jdbcType="VARCHAR" property="kzWw"/>
		<result column="MEMO" jdbcType="VARCHAR" property="memo"/>
		<result column="COLLECTORID" jdbcType="INTEGER" property="collectorId"/>
		<result column="APPOINTORID" jdbcType="INTEGER" property="appointorId"/>
		<result column="COMPANYID" jdbcType="INTEGER" property="companyId"/>
		<result column="SOURCEID" jdbcType="INTEGER" property="sourceId"/>
		<result column="APPOINTNAME" jdbcType="VARCHAR" property="appointName"/>
		<result column="FILMINGAREA" jdbcType="VARCHAR" property="filmingArea"/>
		<result column="SRCNAME" jdbcType="VARCHAR" property="sourceName"/>
		<result column="CHANNELNAME" jdbcType="VARCHAR" property="channelName"/>
		<result column="INVALIDLABEL" jdbcType="VARCHAR" property="invalidLabel"/>
		<result column="SUCCESSTIME" jdbcType="INTEGER" property="successTime"/>
		<result column="AMOUNT" jdbcType="INTEGER" property="amount"/>
		<result column="CREATETIME" jdbcType="INTEGER" property="createTime"/>
	</resultMap>

    <sql id="baseColumn">
        info.ID, info.KZID, info.STATUSID, info.APPOINTORID, info.COLLECTORID, info.COMPANYID, info.SOURCEID
    </sql>

    <!--获取要推送的客资信息-->
	<select id="getClientPushDTOById" parameterType="map" resultMap="infoMap">
		SELECT
		<include refid="baseColumn"/>, (UNIX_TIMESTAMP(NOW()) - info.LASTPUSHTIME) PUSHINTERVAL 
		FROM
			${infoTabName} info
		LEFT JOIN ${detailTabName} det ON det.KZID = info.KZID AND info.COMPANYID = det.COMPANYID
		WHERE
			info.ISDEL = 0
		AND info.KZID = #{kzId};
	</select>

	<!--获取要goeasy推送的客资信息-->
	<select id="getClientGoEasyDTOById" parameterType="map" resultMap="goEasyMap">
		SELECT
			info.ID, info.KZID, info.KZNAME, info.KZPHONE, info.KZWECHAT, info.KZWW, info.KZQQ, det.MEMO, info.APPOINTORID,info.COLLECTORID, info.COMPANYID, info.SOURCEID, det.APPOINTNAME, det.FILMINGAREA, src.SRCNAME,
			src.CHANNELNAME, det.INVALIDLABEL, info.SUCCESSTIME, det.AMOUNT, info.CREATETIME
		FROM
			${infoTabName} info
		LEFT JOIN ${detailTabName} det ON det.KZID = info.KZID AND info.COMPANYID = det.COMPANYID
		LEFT JOIN hm_crm_source src ON src.COMPANYID =  info.COMPANYID AND src.ID = info.SOURCEID
		WHERE
			 info.KZID = #{kzId};
	</select>
    
    <!-- 客资分配给客服后修改客资信息，分配给邀约客服 -->
    <update id="updateClientInfoWhenAllot" parameterType="map">
    	UPDATE ${infoTabName}
		SET CLASSID = #{classId},
		 STATUSID = #{statusId},
		 APPOINTORID = #{appointorId},
		 LASTPUSHTIME = UNIX_TIMESTAMP(NOW()),
		 UPDATETIME = UNIX_TIMESTAMP(NOW()),
		 GROUPID = #{groupId},
		 ALLOTTYPE = #{allotType}
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>

	<!-- 客资分配给客服后修改客资信息,分配给门市 -->
	<update id="updateClientInfoWhenAllotMsjd" parameterType="map">
    	UPDATE ${infoTabName}
		SET CLASSID = #{classId},
		 STATUSID = #{statusId},
		 RECEPTORID = #{receptorId},
		 LASTPUSHTIME = UNIX_TIMESTAMP(NOW()),
		 UPDATETIME = UNIX_TIMESTAMP(NOW()),
		 ALLOTTYPE = #{allotType}
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>
    
    <!-- 客资分配邀约客服后修改客资详情 -->
    <update id="updateClientDetailWhenAllot" parameterType="map">
    	UPDATE ${detailTabName}
		SET APPOINTNAME = #{appointorName}, GROUPNAME = #{groupName}
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>

	<!-- 客资分配门市，后修改客资详情 -->
	<update id="updateClientDetailWhenAllotMsjd" parameterType="map">
    	UPDATE ${detailTabName}
		SET RECEPTORNAME = #{receptorName}
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>
    
    <!-- 客资分配后修改客资的领取时间和最后操作时间 -->
    <update id="updateClientInfoAfterAllot" parameterType="map">
    	UPDATE ${infoTabName}
		SET RECEIVETIME = UNIX_TIMESTAMP(NOW()), UPDATETIME = UNIX_TIMESTAMP(NOW())
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>
    
    <!-- 修改客资状态 -->
    <update id="updateClientInfoStatus" parameterType="map">
    	UPDATE ${infoTabName}
		SET STATUSID = #{statusId},
			CLASSID = #{classId},
		 	UPDATETIME = UNIX_TIMESTAMP(NOW())
		WHERE
			KZID = #{kzId}
		AND COMPANYID = #{companyId}
    </update>

	<!--交接客资-->
	<update id="changeStaff" parameterType="staffChangeVO">

	</update>

	<!-- 获取企业要推送的客资信息 -->	
    <select id="getInfoListBeReadyPush" parameterType="map" resultMap="infoMap">
		SELECT
			channel.PUSHRULE, info.KZID, info.COMPANYID, info.TYPEID, info.CHANNELID, channel.TYPEID,info.SOURCEID
		FROM
			${infoTabName} info
		LEFT JOIN hm_crm_channel channel ON info.CHANNELID = channel.ID AND channel.COMPANYID = #{companyId}
		WHERE
			info.COMPANYID = #{companyId}
		AND info.ISDEL = 0
		AND (
			info.STATUSID = 999
			OR info.STATUSID = 12
		)
		AND (
			UNIX_TIMESTAMP(NOW()) - info.LASTPUSHTIME
		) &gt;= #{interval}
		ORDER BY info.ID ASC
    </select>

	<!--根据拍摄地获取客资数量-->
	<select id="getKzNumByShopId" parameterType="map" resultType="java.lang.Integer">
		SELECT COUNT(1)
		FROM ${infoTabName} info
		WHERE info.SHOPID = #{shopId} AND info.ISDEL = 0
		AND info.COMPANYID = #{companyId}
	</select>

	<!--根据最终拍摄地获取客资数量-->
	<select id="getKzNumByFilmingCode" parameterType="map" resultType="java.lang.Integer">
		SELECT COUNT(1)
		FROM ${detailName} det
		WHERE det.FILMINGCODE = #{filmingCode} AND det.ISDEL = 0
		AND det.COMPANYID = #{companyId}
	</select>
	
	<!-- 根据客资ID集合查询客资信息 -->	
    <select id="listClientsInStrKzids" parameterType="map" resultMap="infoMap">
		SELECT
			info.ID, info.KZID, info.COMPANYID
		FROM
			${infoTabName} info
		WHERE
			info.COMPANYID = #{companyId}
		AND info.ISDEL = 0
		AND (
			info.STATUSID = 12
			OR info.STATUSID = 999
		)
		AND INSTR(#{kzIds},info.KZID) != 0;
    </select>

	<!-- 根据客资ID集合查询可以分配给门市的客资集合 -->
	<select id="listClientsInStrKzids4Msjd" parameterType="map" resultMap="infoMap">
		SELECT
			info.ID, info.KZID, info.COMPANYID
		FROM
			${infoTabName} info
		WHERE
			info.COMPANYID = #{companyId}
		AND info.ISDEL = 0
		AND info.RECEPTORID IS NULL
		AND INSTR(#{kzIds},info.KZID) != 0;
    </select>

</mapper>