<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiein.jupiter.web.dao.ExcelDao">

    <resultMap id="baseMap" type="com.qiein.jupiter.web.entity.dto.ClientExcelDTO">
        <result column="KZID" jdbcType="VARCHAR" property="kzId"/>
        <result column="TYPEID" jdbcType="INTEGER" property="typeId"/>
        <result column="TYPENAME" jdbcType="VARCHAR" property="typeName"/>
        <result column="CLASSID" jdbcType="INTEGER" property="classId"/>
        <result column="CLASSNAME" jdbcType="VARCHAR" property="className"/>
        <result column="STATUSID" jdbcType="INTEGER" property="statusId"/>
        <result column="STATUSNAME" jdbcType="VARCHAR" property="statusName"/>
        <result column="CHANNELID" jdbcType="INTEGER" property="channelId"/>
        <result column="CHANNELNAME" jdbcType="VARCHAR" property="channelName"/>
        <result column="SOURCEID" jdbcType="INTEGER" property="sourceId"/>
        <result column="SOURCENAME" jdbcType="VARCHAR" property="sourceName"/>
        <result column="ZXSTYLE" jdbcType="VARCHAR" property="zxStyle"/>
        <result column="KZNAME" jdbcType="VARCHAR" property="kzName"/>
        <result column="SEXNAME" jdbcType="VARCHAR" property="sex"/>
        <result column="KZPHONE" jdbcType="VARCHAR" property="kzPhone"/>
        <result column="KZWECHAT" jdbcType="VARCHAR" property="kzWechat"/>
        <result column="KZQQ" jdbcType="VARCHAR" property="kzQq"/>
        <result column="KZWW" jdbcType="VARCHAR" property="kzWw"/>
        <result column="COLLECTORID" jdbcType="INTEGER" property="collectorId"/>
        <result column="COLLECTORNAME" jdbcType="VARCHAR" property="collectorName"/>
        <result column="APPOINTORID" jdbcType="INTEGER" property="appointorId"/>
        <result column="APPOINTNAME" jdbcType="VARCHAR" property="appointName"/>
        <result column="APPOINTTIME" jdbcType="VARCHAR" property="appointTime"/>
        <result column="UPDATETIME" jdbcType="VARCHAR" property="updateTime"/>
        <result column="CREATETIME" jdbcType="VARCHAR" property="createTime"/>
        <result column="SHOPID" jdbcType="INTEGER" property="shopId"/>
        <result column="SHOPNAME" jdbcType="VARCHAR" property="shopName"/>
        <result column="AMOUNT" jdbcType="VARCHAR" property="amount"/>
        <result column="COMPANYID" jdbcType="INTEGER" property="companyId"/>
        <result column="VALIDTIME" jdbcType="VARCHAR" property="validTime"/>
        <result column="COMESHOPTIME" jdbcType="VARCHAR" property="comeShopTime"/>
        <result column="SUCCESSTIME" jdbcType="VARCHAR" property="successTime"/>
        <result column="TRACETIME" jdbcType="VARCHAR" property="traceTime"/>
        <result column="RECEIVETIME" jdbcType="VARCHAR" property="receiveTime"/>
        <result column="MARRYTIME" jdbcType="VARCHAR" property="marryTime"/>
        <result column="YPTIME" jdbcType="VARCHAR" property="ypTime"/>
        <result column="ADADDRESS" jdbcType="VARCHAR" property="adAddress"/>
        <result column="ADID" jdbcType="VARCHAR" property="adId"/>
        <result column="OPERAID" jdbcType="INTEGER" property="operaId"/>
        <result column="ADDRESS" jdbcType="VARCHAR" property="address"/>
        <result column="GROUPNAME" jdbcType="VARCHAR" property="groupName"/>
        <result column="GROUPID" jdbcType="VARCHAR" property="groupId"/>
        <result column="KEYWORD" jdbcType="VARCHAR" property="keyWord"/>
        <result column="MEMO" jdbcType="VARCHAR" property="remark"/>
    </resultMap>

    <resultMap id="baseNewsMap" type="com.qiein.jupiter.web.entity.dto.ClientExcelNewsDTO">
        <result column="KZID" jdbcType="VARCHAR" property="kzId"/>
        <result column="TYPEID" jdbcType="INTEGER" property="typeId"/>
        <result column="TYPENAME" jdbcType="VARCHAR" property="typeName"/>
        <result column="CLASSID" jdbcType="INTEGER" property="classId"/>
        <result column="CLASSNAME" jdbcType="VARCHAR" property="className"/>
        <result column="STATUSID" jdbcType="INTEGER" property="statusId"/>
        <result column="STATUSNAME" jdbcType="VARCHAR" property="statusName"/>
        <result column="CHANNELID" jdbcType="INTEGER" property="channelId"/>
        <result column="CHANNELNAME" jdbcType="VARCHAR" property="channelName"/>
        <result column="SOURCEID" jdbcType="INTEGER" property="sourceId"/>
        <result column="SOURCENAME" jdbcType="VARCHAR" property="sourceName"/>
        <result column="ZXSTYLE" jdbcType="VARCHAR" property="zxStyle"/>
        <result column="KZNAME" jdbcType="VARCHAR" property="kzName"/>
        <result column="SEXNAME" jdbcType="VARCHAR" property="sex"/>
        <result column="KZPHONE" jdbcType="VARCHAR" property="kzPhone"/>
        <result column="KZWECHAT" jdbcType="VARCHAR" property="kzWechat"/>
        <result column="KZQQ" jdbcType="VARCHAR" property="kzQq"/>
        <result column="KZWW" jdbcType="VARCHAR" property="kzWw"/>
        <result column="COLLECTORID" jdbcType="INTEGER" property="collectorId"/>
        <result column="COLLECTORNAME" jdbcType="VARCHAR" property="collectorName"/>
        <result column="APPOINTORID" jdbcType="INTEGER" property="appointorId"/>
        <result column="APPOINTNAME" jdbcType="VARCHAR" property="appointName"/>
        <result column="APPOINTTIME" jdbcType="VARCHAR" property="appointTime"/>
        <result column="UPDATETIME" jdbcType="VARCHAR" property="updateTime"/>
        <result column="CREATETIME" jdbcType="VARCHAR" property="createTime"/>
        <result column="SHOPID" jdbcType="INTEGER" property="shopId"/>
        <result column="SHOPNAME" jdbcType="VARCHAR" property="shopName"/>
        <result column="AMOUNT" jdbcType="VARCHAR" property="amount"/>
        <result column="COMPANYID" jdbcType="INTEGER" property="companyId"/>
        <result column="VALIDTIME" jdbcType="VARCHAR" property="validTime"/>
        <result column="COMESHOPTIME" jdbcType="VARCHAR" property="comeShopTime"/>
        <result column="SUCCESSTIME" jdbcType="VARCHAR" property="successTime"/>
        <result column="TRACETIME" jdbcType="VARCHAR" property="traceTime"/>
        <result column="RECEIVETIME" jdbcType="VARCHAR" property="receiveTime"/>
        <result column="MARRYTIME" jdbcType="INTEGER" property="marryTime"/>
        <result column="YPTIME" jdbcType="INTEGER" property="ypTime"/>
        <result column="ADADDRESS" jdbcType="VARCHAR" property="adAddress"/>
        <result column="ADID" jdbcType="VARCHAR" property="adId"/>
        <result column="OPERAID" jdbcType="INTEGER" property="operaId"/>
        <result column="ADDRESS" jdbcType="VARCHAR" property="address"/>
        <result column="GROUPNAME" jdbcType="VARCHAR" property="groupName"/>
        <result column="GROUPID" jdbcType="VARCHAR" property="groupId"/>
        <result column="KEYWORD" jdbcType="VARCHAR" property="keyWord"/>
        <result column="MEMO" jdbcType="VARCHAR" property="remark"/>
        <result column="OLDKZNAME" jdbcType="VARCHAR" property="oldKzName"/>
        <result column="OLDKZPHONE" jdbcType="VARCHAR" property="oldKzPhone"/>
        <result column="RECEPTORNAME" jdbcType="VARCHAR" property="receptorName"></result>
        <result column="RECEPTORID" jdbcType="VARCHAR" property="receptorId"></result>
        <result column="MATENAME" jdbcType="VARCHAR" property="mateName"></result>
        <result column="MATEPHONE" jdbcType="VARCHAR" property="matePhone"></result>
        <result column="MATEWECHAT" jdbcType="VARCHAR" property="mateWeChat"></result>
        <result column="MATEQQ" jdbcType="VARCHAR" property="mateQq"></result>
        <result column="YXLEVEL" jdbcType="INTEGER" property="yxLevel"></result>
        <result column="FILMINGCODE" jdbcType="VARCHAR" property="filmingCode"></result>
        <result column="FILMINGAREA" jdbcType="VARCHAR" property="filmingArea"></result>
        <result column="YSRANGE" jdbcType="INTEGER" property="ysRange"></result>
        <result column="STAYAMOUNT" jdbcType="INTEGER" property="stayaMount"></result>
        <result column="HTNUM" jdbcType="VARCHAR" property="htNum"></result>
        <result column="MARRYTIME" jdbcType="INTEGER" property="marryTime"></result>
    </resultMap>

    <resultMap id="countMap" type="com.qiein.jupiter.web.entity.dto.ClientSortCountDTO">
        <result column="wrong_count" property="wrongCount"></result>
        <result column="right_count" property="rightCount"></result>
        <result column="repeats" property="repeats"></result>
    </resultMap>
    <sql id="Base_Column_List">
        temp.KZID, temp.TYPEID, temp.CLASSID, temp.TYPENAME, temp.STATUSID, temp.STATUSNAME, temp.SRCTYPE, temp.CHANNELID, temp.CHANNELNAME,
        temp.SOURCEID, temp.SOURCENAME, temp.ZXSTYLE, temp.KZNAME, temp.SEXNAME, temp.KZPHONE, temp.KZWECHAT, temp.KZQQ, temp.KZWW, temp.COLLECTORID, temp.COLLECTORNAME,
        temp.APPOINTORID, temp.APPOINTNAME, temp.APPOINTTIME, temp.MEMO, temp.CREATETIME, temp.SHOPID, temp.SHOPNAME,
        temp.COMPANYID, temp.ADADDRESS, temp.ADID, temp.OPERAID, temp.ADDRESS, temp.GROUPID, temp.GROUPNAME, temp.KEYWORD
    </sql>
    <sql id="Base_Column_News_List">
        temp.KZID, temp.TYPEID, temp.CLASSID, temp.TYPENAME, temp.STATUSID, temp.STATUSNAME, temp.SRCTYPE, temp.CHANNELID, temp.CHANNELNAME,
        temp.SOURCEID, temp.SOURCENAME, temp.ZXSTYLE, temp.KZNAME, temp.SEXNAME, temp.KZPHONE, temp.KZWECHAT, temp.KZQQ, temp.KZWW, temp.COLLECTORID, temp.COLLECTORNAME,
        temp.APPOINTORID, temp.APPOINTNAME, temp.APPOINTTIME, temp.MEMO, temp.CREATETIME, temp.SHOPID, temp.SHOPNAME,
        temp.COMPANYID, temp.ADADDRESS, temp.ADID, temp.OPERAID, temp.ADDRESS, temp.GROUPID, temp.GROUPNAME, temp.KEYWORD, temp.YXLEVEL, temp.YSRANGE, temp.YPTIME,
        temp.STAYAMOUNT, temp.AMOUNT, temp.MARRYTIME, temp.RECEPTORID, temp.RECEPTORNAME, temp.HTNUM, temp.OLDKZNAME, temp.OLDKZPHONE, temp.MATENAME, temp.MATEPHONE, temp.MATEWECHAT, temp.MATEQQ,
        temp.COMESHOPTIME, temp.SUCCESSTIME, temp.RECEIVETIME, temp.TRACETIME, temp.INVALIDLABEL, temp.sex,temp.MARRYTIMESTR,temp.YSRANGESTR,temp.YXLEVELSTR,temp.YPTIMESTR,temp.ZXSTYLESTR
    </sql>


    <!-- 删除员工客资缓存记录 -->
    <delete id="deleteTempByStaffId" parameterType="map">
        DELETE FROM ${tempName}
        WHERE OPERAID = ${operaId};
    </delete>

    <!-- 批量写入客资临时缓存表 -->
    <insert id="insertExcelClientInfo">
        INSERT INTO ${tempName}
        (KZID, TYPENAME, STATUSID,STATUSNAME, CHANNELNAME, SOURCENAME,ZXSTYLE, KZNAME,SEX,KZPHONE, KZWECHAT, KZQQ, KZWW,
        COLLECTORNAME,
        APPOINTNAME,APPOINTTIME,RECEPTORNAME,AMOUNT,CREATETIME, UPDATETIME,COMESHOPTIME,SUCCESSTIME, SHOPNAME,
        COMPANYID, OPERAID, ADDRESS, GROUPNAME,KEYWORD,MEMO
        ,MATENAME,MATEPHONE,MATEWECHAT,MATEQQ,MARRYTIME,YPTIME,ADADDRESS,ADID,YXLEVEL,INVALIDLABEL,YSRANGE,OLDKZNAME,OLDKZPHONE,STAYAMOUNT,HTNUM
        ,MARRYTIMESTR,YPTIMESTR,YSRANGESTR,YXLEVELSTR,ZXSTYLESTR)
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.kzId},#{item.typeName}, #{item.statusId},#{item.statusName},#{item.channelName},
            #{item.sourceName},#{item.zxStyle},#{item.kzName},#{item.sex},#{item.kzPhone}, #{item.kzWechat},
            #{item.kzQq}, #{item.kzWw}, #{item.collectorName},
            #{item.appointName},#{item.appointTime},#{item.receptorName},#{item.amount},
            #{item.createTime},unix_timestamp(now()),#{item.comeShopTime},#{item.successTime}, #{item.shopName},
            #{item.companyId},
            #{item.operaId}, #{item.address}, #{item.groupName}, #{item.keyWord},
            #{item.remark},#{item.mateName},#{item.matePhone},#{item.mateWeChat},#{item.mateQq},#{item.marryTime},
            #{item.ypTime},#{item.adAddress},#{item.adId},#{item.yxLevel},#{item.invalidLabel},#{item.ysRange},#{item.oldKzName},#{item.oldKzPhone},
            #{item.stayaMount},#{item.htNum},#{item.marryTimeStr},#{item.ypTimeStr},#{item.ysRangeStr},#{item.yxLevelStr},#{item.zxStyleStr}
            )
        </foreach>
    </insert>

    <!-- 清空缓存表 -->
    <update id="truncateTempTable">
        TRUNCATE TABLE ${tempName};
    </update>

    <!-- 设置企业ID -->
    <update id="updateCompanyId" parameterType="map">
        UPDATE ${tempName} temp
        SET COMPANYID = #{companyId}
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 没有客资ID的，设置UUID -->
    <update id="updateKzid" parameterType="map">
        UPDATE ${tempName} temp
        SET KZID = UUID()
        WHERE (KZID IS NULL OR KZID = '') AND temp.OPERAID = #{staffId};
    </update>

    <!-- 设置咨询类型ID -->
    <update id="updateType" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.TYPEID = (
            CASE
            WHEN temp.TYPENAME LIKE '婚纱%'
                THEN 1
            WHEN temp.TYPENAME LIKE '写真%'
                THEN 2
            WHEN temp.TYPENAME LIKE '全家%'
                THEN 3
            WHEN temp.TYPENAME LIKE '宝宝%'
                THEN 4
            WHEN temp.TYPENAME LIKE '孕妇%'
                THEN 5
            WHEN temp.TYPENAME LIKE '亲子%'
                THEN 6
            WHEN temp.TYPENAME LIKE '成长%'
                THEN 7
            WHEN temp.TYPENAME LIKE '外景%'
                THEN 8
            WHEN temp.TYPENAME LIKE '礼服%'
                THEN 9
            WHEN temp.TYPENAME LIKE '纪念%'
                THEN 10
            WHEN temp.TYPENAME LIKE '形象%'
                THEN 11
            WHEN temp.TYPENAME LIKE '闺蜜%'
                THEN 12
            WHEN temp.TYPENAME LIKE '母女%'
                THEN 13
            WHEN temp.TYPENAME LIKE '婚庆%'
                THEN 14
            WHEN temp.TYPENAME LIKE '证件%'
                THEN 15
            WHEN temp.TYPENAME LIKE '补拍%'
                THEN 98
            ELSE 99 END
        )
        WHERE
            temp.OPERAID = #{staffId};
    </update>

    <!-- 设置状态名称，唯一版 -->
    <update id="updateStatusName" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.STATUSNAME = (SELECT sts.STATUSNAME
                               FROM hm_crm_client_status sts
                               WHERE sts.COMPANYID = temp.COMPANYID AND sts.STATUSID = temp.STATUSID)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 设置客资当前分类ID,唯一版 -->
    <update id="updateClassId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.CLASSID = (SELECT sts.CLASSID
                            FROM hm_crm_client_status sts
                            WHERE sts.COMPANYID = temp.COMPANYID AND sts.STATUSID = temp.STATUSID)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 设置来源ID -->
    <update id="updateSrcIdAndType" parameterType="map">
        UPDATE ${tempName} temp
            INNER JOIN hm_crm_source src on temp.SOURCENAME = src.SRCNAME
        SET temp.SOURCEID = src.ID, temp.SRCTYPE = src.TYPEID
        WHERE
            temp.OPERAID = #{staffId} and src.companyId = #{companyId};
    </update>

    <!-- 设置来源和渠道-->
    <update id="updateSrcAndChannel" parameterType="map">
        UPDATE ${tempName} temp
            INNER JOIN hm_crm_source src on temp.SOURCENAME = src.SRCNAME
        SET temp.SOURCEID  = src.ID, temp.SRCTYPE = src.TYPEID, temp.CHANNELNAME = src.CHANNELNAME,
            temp.CHANNELID = src.CHANNELID
        WHERE
            temp.OPERAID = #{staffId} and src.companyId = #{companyId};
    </update>

    <!--设置渠道ID-->
    <update id="updateChannelId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.CHANNELID = (SELECT channel.ID
                              FROM hm_crm_channel channel
                              WHERE channel.COMPANYID = temp.COMPANYID AND channel.ISSHOW = 1 AND
                                    channel.CHANNELNAME = temp.CHANNELNAME)
        WHERE
            temp.OPERAID = #{staffId};
    </update>

    <!-- 更新最后跟进时间为当前系统时间 -->
    <update id="updateUpdateTime" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.UPDATETIME = unix_timestamp(now())
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 更新提报人ID -->
    <update id="updateCollectorId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.COLLECTORID = (SELECT sf.ID
                                FROM hm_pub_staff sf
                                WHERE
                                    sf.COMPANYID = temp.COMPANYID AND sf.NICKNAME = temp.COLLECTORNAME AND sf.ISDEL = 0
                                LIMIT 1)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 更新提报人id是空的记录 -->
    <update id="updateEmptyCollector">
        UPDATE ${tempName} temp
        SET temp.COLLECTORNAME = CONCAT("", temp.COLLECTORNAME)
        WHERE temp.COLLECTORID IS NULL
              AND temp.OPERAID = #{operaId}
              AND left(temp.COLLECTORNAME, 1) != '-';
    </update>

    <!-- 更新邀约员ID -->
    <update id="updateAppointId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.APPOINTORID = (SELECT sf.ID
                                FROM hm_pub_staff sf
                                WHERE sf.COMPANYID = temp.COMPANYID AND sf.NICKNAME = temp.APPOINTNAME AND sf.ISDEL = 0
                                LIMIT 1)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!-- 更新邀约客服id是空的记录 -->
    <update id="updateEmptyAppoint">
        UPDATE ${tempName} temp
        SET temp.APPOINTNAME = CONCAT("", temp.APPOINTNAME)
        WHERE temp.APPOINTORID IS NULL
              AND temp.OPERAID = #{operaId}
              AND left(APPOINTNAME, 1) != '-';
    </update>

    <!-- 更新拍摄地ID -->
    <update id="updateShopId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.SHOPID = (SELECT sp.ID
                           FROM hm_pub_shop sp
                           WHERE sp.COMPANYID = temp.COMPANYID AND sp.SHOPNAME = temp.SHOPNAME
                           LIMIT 1)
        WHERE temp.OPERAID = #{staffId} and temp.companyId = #{companyId};
    </update>

    <!-- 设置邀约小组ID,唯一版 -->
    <update id="updateGroupId" parameterType="map">
        UPDATE ${tempName} temp
        SET temp.GROUPID = (SELECT grp.GROUPID
                            FROM hm_pub_group grp
                            WHERE grp.COMPANYID = temp.COMPANYID AND grp.GROUPNAME = temp.GROUPNAME)
        WHERE temp.OPERAID = #{staffId} and temp.companyId = #{companyId};
    </update>

    <!--更新门市id-->
    <update id="updateReceptorId">
        update ${tempName} temp
        set temp.RECEPTORID = (select sf.ID
                               from hm_pub_staff sf
                               where sf.NICKNAME = temp.RECEPTORNAME and sf.COMPANYID = temp.COMPANYID AND sf.ISDEL = 0
                               LIMIT 1)
        where temp.operaid = #{staffId} and temp.companyId = #{companyId};
    </update>

    <!--获取导入的所有客资列表-->
    <select id="getAllRecordByStaffId" parameterType="map" resultMap="baseNewsMap">
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE temp.OPERAID = #{staffId};
    </select>

    <!--获取重复客资列表-->
    <select id="getRepeatRecord" parameterType="map" resultMap="baseNewsMap">
        SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        LEFT JOIN ${tableName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a group by
        kzphone,kzqq,kzwechat having client_count> 1) result)
    </select>

    <!--获取excel中重复客资列表-->
    <select id="getExcelRepeatRecord" parameterType="map" resultMap="baseNewsMap">
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        (
        (
        SELECT
        COUNT(1)
        FROM ${tempName} a
        WHERE
        (temp.KZPHONE = a.KZPHONE OR temp.KZQQ = a.KZQQ OR temp.KZWECHAT = a.KZWECHAT )
        AND temp.OPERAID = #{staffId}
        ) > 1
        )
        ORDER BY temp.ID DESC
    </select>

    <!-- 插入客资基础信息表-->
    <insert id="insertBaseInfoByStaffId" parameterType="map">
        INSERT INTO ${tabName} (
        KZID, TYPEID, CLASSID, KZNAME, KZPHONE, KZWECHAT, KZQQ, KZWW, SEX, STATUSID, SRCTYPE, CHANNELID, SOURCEID,
        COLLECTORID, APPOINTORID,
        APPOINTTIME, UPDATETIME, CREATETIME, SHOPID, RECEPTORID, COMPANYID, COMESHOPTIME, SUCCESSTIME, RECEIVETIME,
        GROUPID
        ) (SELECT
        temp.KZID,
        temp.TYPEID,
        temp.CLASSID,
        temp.KZNAME,
        temp.KZPHONE,
        temp.KZWECHAT,
        temp.KZQQ,
        temp.KZWW,
        temp.SEX,
        temp.STATUSID,
        temp.SRCTYPE,
        temp.CHANNELID,
        temp.SOURCEID,
        temp.COLLECTORID,
        temp.APPOINTORID,
        temp.APPOINTTIME,
        temp.UPDATETIME,
        temp.CREATETIME,
        temp.SHOPID,
        temp.RECEPTORID,
        temp.COMPANYID,
        temp.COMESHOPTIME,
        temp.SUCCESSTIME,
        temp.RECEIVETIME,
        temp.GROUPID
        from ${tempName} temp

        left join
        -- 重复客资
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tabName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a where a.OPERAID =
        #{staffId} group by kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ON temp.kzid = b.kzid
        left join
        -- 错误客资
        (select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))) c
        ON temp.kzid = c.kzid
        where temp.OPERAID = #{staffId} and b.KZID is null and c.kzid is null
        );
    </insert>

    <!-- 插入客资详情表,唯一版 -->
    <insert id="insertDetailInfoByStaffId" parameterType="map">
        INSERT INTO ${tabName} (
        KZID, ZXSTYLE, ADADDRESS, ADID, MARRYTIME, YPTIME, MATENAME, MATEPHONE, MATEWECHAT, MATEQQ, COMPANYID, YXLEVEL,
        INVALIDLABEL, YSRANGE, ADDRESS, GROUPNAME, KEYWORD, COLLECTORNAME, APPOINTNAME, RECEPTORNAME, MEMO, SHOPNAME,
        AMOUNT, CREATETIME, OLDKZNAME, OLDKZPHONE, STAYAMOUNT
        ) (select temp.KZID,
        temp.ZXSTYLE,
        temp.ADADDRESS,
        temp.ADID,
        temp.MARRYTIME,
        temp.YPTIME,
        temp.MATENAME,
        temp.MATEPHONE,
        temp.MATEWECHAT,
        temp.MATEQQ,
        temp.COMPANYID,
        temp.YXLEVEL,
        temp.INVALIDLABEL,
        temp.YSRANGE,
        temp.ADDRESS,
        temp.GROUPNAME,
        temp.KEYWORD,
        temp.COLLECTORNAME,
        temp.APPOINTNAME,
        temp.RECEPTORNAME,
        temp.MEMO,
        temp.SHOPNAME,
        temp.AMOUNT,
        temp.CREATETIME,
        temp.OLDKZNAME,
        temp.OLDKZPHONE,
        temp.STAYAMOUNT
        from ${tempName} temp

        left join
        -- 重复客资
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tabName} detail
        ON detail.KZID is not null
        WHERE
        detail.KZID IS NOT NULL
        AND temp.OPERAID = #{staffId}
        AND temp.kzid = detail.kzid
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a where a.OPERAID =
        #{staffId} group by kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ON temp.kzid = b.kzid
        left join
        -- 错误客资
        (select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))) c
        ON temp.kzid = c.kzid
        where temp.OPERAID = #{staffId} and b.KZID is null and c.kzid is null
        );
    </insert>

    <!--插入客资备注表-->
    <insert id="addExcelKzRemark" parameterType="map">
        INSERT INTO ${tabName}
        (KZID, CONTENT, COMPANYID)
            (SELECT
                 temp.KZID,
                 temp.MEMO,
                 temp.COMPANYID
             FROM ${tempName} temp
             WHERE temp.OPERAID = #{staffId})
    </insert>

    <!-- 批量删除员工客资缓存记录 -->
    <delete id="batchDeleteTemp" parameterType="map">
        DELETE FROM ${tempName}
        WHERE OPERAID = #{operaId}
        AND KZID IN
        <foreach collection="kzIdArr" item="kzid" index="index"
                 open="(" close=")" separator=",">
            #{kzid}
        </foreach>
    </delete>

    <!--批量编辑客资缓存记录-->
    <update id="batchEditTemp" parameterType="map">
        UPDATE ${tempName}
        <set>
            <if test="info.typeName != null and info.typeName != ''">
                TYPENAME = #{info.typeName},
            </if>
            <if test="info.statusName != null and info.statusName != ''">
                STATUSNAME = #{info.statusName},
            </if>
            <if test="info.sourceName != null and info.sourceName != ''">
                SOURCENAME = #{info.sourceName},
            </if>
            <if test="info.shopName != null and info.shopName != ''">
                SHOPNAME = #{info.shopName},
            </if>
            <if test="info.collectorName != null and info.collectorName != ''">
                COLLECTORNAME = #{info.collectorName},
            </if>
            <if test="info.appointName != null and info.appointName != ''">
                APPOINTNAME = #{info.appointName},
            </if>
            <if test="info.currentTime != null and info.currentTime == true ">
                CREATETIME = unix_timestamp(now()),
            </if>
            <if test="info.marryTimeStr != null and info.marryTimeStr != ''">
                MARRYTIMESTR = #{info.marryTimeStr},
            </if>
            <if test="info.ypTimeStr != null and info.ypTimeStr != ''">
                YPTIMESTR = #{info.ypTimeStr},
            </if>
            <if test="info.zxStyleStr != null and info.zxStyleStr != ''">
                ZXSTYLESTR = #{info.zxStyleStr},
            </if>
            <if test="info.ysRangeStr != null and info.ysRangeStr != ''">
                YSRANGESTR = #{info.ysRangeStr},
            </if>
            <if test="info.yxLevelStr != null and info.yxLevelStr != ''">
                yxLevelStr = #{info.yxLevelStr}
            </if>
        </set>
        WHERE OPERAID = #{info.operaId}
        AND KZID IN
        <foreach collection="kzIdArr" item="kzid" index="index" open="(" close=")" separator=",">
            #{kzid}
        </foreach>
    </update>

    <!--设置状态ID和classId-->
    <update id="updateStatusIdAndClassId" parameterType="map">
        UPDATE ${tempName} temp
            LEFT JOIN hm_crm_client_status sts on sts.COMPANYID = temp.COMPANYID AND sts.STATUSNAME = temp.STATUSNAME
        SET temp.STATUSID = sts.STATUSID, temp.CLASSID = sts.CLASSID
        WHERE
            temp.OPERAID = #{operaId} and sts.COMPANYID = #{companyId}
    </update>


    <!--获取错误客资-->
    <select id="getExcelErrorClient" resultMap="baseNewsMap">
        select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))
    </select>

    <!--获取正常客资-->
    <select id="getExcelSuccessClient" resultMap="baseNewsMap">
        -- 所有客资
        select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        left join
        -- 重复客资
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tableName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a group by
        kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ON temp.kzid = b.kzid
        left join
        -- 错误客资
        (select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))) c
        ON temp.kzid = c.kzid
        where temp.OPERAID = #{staffId} and b.KZID is null and c.kzid is null
    </select>

    <!--获取客资数量-->
    <select id="getMultipleKzStatusCount" resultMap="countMap">
        SELECT
        right_count,wrong_count,repeats
        FROM
        (
        SELECT
        count(1) AS right_count
        FROM
        (
        -- 所有客资
        select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        left join
        -- 重复客资
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tableName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a group by
        kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ON temp.kzid = b.kzid
        left join
        -- 错误客资
        (select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))) c
        ON temp.kzid = c.kzid
        where temp.OPERAID = #{staffId} and b.KZID is null and c.kzid is null
        ) tmp_count
        ) a,
        (
        SELECT
        count(1) AS wrong_count
        FROM
        ${tempName} temp
        WHERE
        temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT REGEXP
        '^[1][3456789][0-9]{9}$')
        or ((temp.KZWECHAT IS NOT NULL and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))
        ) b,
        (
        SELECT DISTINCT
        count(1) AS repeats
        FROM
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tableName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a group by
        kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ) c
    </select>


    <!--更改咨询方式字典编码-->
    <update id="updateZxStyleDictionaryCode">
        UPDATE ${tempName} temp
        SET temp.ZXSTYLE = (SELECT DICCODE
                            FROM hm_crm_dictionary dictionary
                            WHERE dictionary.COMPANYID = temp.COMPANYID AND dictionary.DICNAME = temp.ZXSTYLESTR and
                                  dictionary.DICTYPE = #{dictionaryType} and dictionary.COMPANYID = #{companyId} and dictionary.ISSHOW = 1)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!--更改意向等级字典编码-->
    <update id="updateYxLevelDictionaryCode">
        UPDATE ${tempName} temp
        SET temp.YXLEVEL = IFNULL((SELECT DICCODE
                            FROM hm_crm_dictionary dictionary
                            WHERE dictionary.COMPANYID = temp.COMPANYID AND dictionary.DICNAME = temp.YXLEVELSTR and
                                  dictionary.DICTYPE = #{dictionaryType} and dictionary.COMPANYID = #{companyId} and dictionary.ISSHOW = 1),0)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!--更改预算范围字典编码-->
    <update id="updateYsRangeDictionaryCode">
        UPDATE ${tempName} temp
        SET temp.YSRANGE = IFNULL((SELECT DICCODE
                            FROM hm_crm_dictionary dictionary
                            WHERE dictionary.COMPANYID = temp.COMPANYID AND dictionary.DICNAME = temp.YSRANGESTR and
                                  dictionary.DICTYPE = #{dictionaryType} and dictionary.COMPANYID = #{companyId} and dictionary.ISSHOW = 1),0)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!--更新预拍时间的字典编码-->
    <update id="updateYpTimeDictionaryCode">
        UPDATE ${tempName} temp
        SET temp.YPTIME = IFNULL((SELECT DICCODE
                           FROM hm_crm_dictionary dictionary
                           WHERE dictionary.COMPANYID = temp.COMPANYID AND dictionary.DICNAME = temp.YPTIMESTR and
                                 dictionary.DICTYPE = #{dictionaryType} and dictionary.COMPANYID = #{companyId} and dictionary.ISSHOW = 1),0)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!--更新婚期时间的字典编码-->
    <update id="updateMarryTimeDictionaryCode">
        UPDATE ${tempName} temp
        SET temp.MARRYTIME = IFNULL((SELECT DICCODE
                              FROM hm_crm_dictionary dictionary
                              WHERE dictionary.COMPANYID = temp.COMPANYID AND dictionary.DICNAME = temp.MARRYTIMESTR and
                                    dictionary.DICTYPE = #{dictionaryType} and dictionary.COMPANYID = #{companyId} and dictionary.ISSHOW = 1),0)
        WHERE temp.OPERAID = #{staffId};
    </update>

    <!--批量添加日志-->
    <insert id="batchAddInfoLog">
        INSERT INTO ${logTabName} (
        KZID, COMPANYID, OPERAID, OPERANAME, MEMO, OPERATIME, LOGTYPE
        ) (SELECT temp.kzid,temp.companyid,'${staffId}' as OPERAID,'${nickName}' as OPERANAME ,'${memo}' as
        MEMO,unix_timestamp(now()) as OPERATIME,'${logType}' as LOGTYPE
        from ${tempName} temp
        left join
        -- 重复客资
        (SELECT
        DISTINCT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        inner join ${tabName} info
        ON info.KZID is not null
        WHERE
        info.KZID IS NOT NULL
        AND info.ISDEL = 0
        AND temp.OPERAID = #{staffId}
        AND (( temp.KZPHONE = info.KZPHONE or temp.KZPHONE = info.KZWECHAT or temp.KZPHONE = info.KZQQ)
        or ( temp.KZWECHAT = info.KZPHONE or temp.KZWECHAT = info.KZWECHAT or temp.KZWECHAT = info.KZQQ)
        or ( temp.KZQQ = info.KZPHONE or temp.KZQQ = info.KZWECHAT or temp.KZQQ = info.KZQQ))
        union
        SELECT
        <include refid="Base_Column_News_List"/>
        FROM ${tempName} temp
        WHERE
        temp.kzid in (select kzid from (select kzid,count(1) as client_count from ${tempName} a where a.OPERAID =
        #{staffId} group by kzphone,kzqq,kzwechat having client_count> 1) result)
        ) b
        ON temp.kzid = b.kzid
        left join
        -- 错误客资
        (select
        <include refid="Base_Column_News_List"/>
        from ${tempName} temp
        where temp.OPERAID = #{staffId} and (((temp.KZPHONE is not null and temp.KZPHONE != '') and temp.KZPHONE NOT
        REGEXP '^[1][3456789][0-9]{9}$')
        or ( (temp.KZWECHAT is not null and temp.KZWECHAT != '') and temp.KZWECHAT NOT REGEXP
        '^[a-zA-Z0-9]{1}[-_a-zA-Z0-9]{5,30}$')
        or ((temp.kzqq is not null and temp.kzqq != '') and temp.kzqq not REGEXP '[1-9][0-9]{4,9}')
        or (temp.CLASSID IS NULL OR temp.CLASSID = 0)
        or temp.TYPEID is null
        or temp.CHANNELID is NULL
        or temp.SOURCEID is NULL
        or temp.COLLECTORID IS NULL
        or (temp.CREATETIME IS NULL or temp.CREATETIME = 0)
        or (temp.KZPHONE is null and temp.KZWECHAT is null and temp.KZQQ is null and temp.KZWW is null)
        or (temp.SHOPID is null and temp.SHOPNAME is not null)
        or (temp.APPOINTORID is null and temp.APPOINTNAME is not null)
        or (temp.RECEPTORID is null and temp.RECEPTORNAME IS not null)
        or (temp.CLASSID != 1 AND temp.APPOINTORID IS NULL )
        or (temp.CLASSID = 4 AND (temp.SHOPID IS NULL OR temp.COMESHOPTIME IS NULL OR temp.RECEPTORID IS NULL))
        or (temp.CLASSID = 3 AND (temp.APPOINTTIME IS NULL OR temp.SHOPID IS NULL))
        or (temp.CLASSID = 5 AND (temp.SHOPID IS NULL or temp.RECEPTORID IS NULL or temp.SUCCESSTIME IS NULL or
        temp.AMOUNT IS NULL))
        or (temp.YXLEVELSTR is not null and temp.YXLEVEL IS NULL)
        Or (temp.YPTIMESTR IS NOT NULL AND temp.YPTIME IS NULL)
        or (temp.YSRANGESTR IS NOT NULL AND temp.YSRANGE IS NULL)
        or (temp.MARRYTIMESTR IS NOT NULL AND temp.MARRYTIME IS NULL)
        or (temp.ZXSTYLESTR IS NOT NULL AND temp.ZXSTYLE IS NULL))) c
        ON temp.kzid = c.kzid
        where temp.OPERAID = #{staffId} and b.KZID is null and c.kzid is null
        )
    </insert>
</mapper>