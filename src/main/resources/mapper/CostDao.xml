<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiein.jupiter.web.dao.CostDao">
    <resultMap id="Cost" type="com.qiein.jupiter.web.entity.vo.CostShowVO">
        <id column="ID" jdbcType="VARCHAR" property="id" />
        <result column="TOTALCOST" jdbcType="DECIMAL" property="totalCost"/>
        <result column="SRCID" jdbcType="INTEGER" property="srcId" />
        <result column="SRCNAME" jdbcType="VARCHAR" property="srcName" />
        <result column="SRCIMG" jdbcType="VARCHAR" property="srcImg" />
        <collection property="costPOS" ofType="com.qiein.jupiter.web.entity.po.CostPO">
            <id column="COSTID" jdbcType="VARCHAR" property="id" />
            <result column="COST" jdbcType="DECIMAL" property="cost" />
            <result column="COSTTIME" jdbcType="VARCHAR" property="costTime" />
            <result column="COMPANYID" jdbcType="INTEGER" property="companyId" />
            <result column="COSTDATE" jdbcType="VARCHAR" property="date" />
        </collection>
    </resultMap>


<sql id="costlog">
    COSTID,OPERAID,OPERANAME,OPERATIME,COMPANYID,MEMO
</sql>

  <select id="costList" resultMap="Cost">
         SELECT
			a.ID COSTID,
			sourse.ID,
			SRCNAME,
			SRCIMG,
			(
				SELECT
					c.COST
				FROM
					hm_crm_cost c
				WHERE
					c.COSTTIME = a.COSTTIME
				AND c.SRCID = a.SRCID
			) COST,
			SRCID,
			FROM_UNIXTIME(a.COSTTIME, '%Y/%m/%d') COSTTIME,
			FROM_UNIXTIME(a.COSTTIME, '%d ') COSTDATE,
			(
				SELECT
					SUM(COST)
				FROM
					hm_crm_cost b
				WHERE
					a.SRCID = b.SRCID
				AND FROM_UNIXTIME(b.COSTTIME, '%Y/%m/%d ') LIKE CONCAT(
					"%",
		#{month},
		 "%"
		)
				AND b.COMPANYID = #{companyId}
				) TOTALCOST
				FROM
			(
				SELECT
					SOURCE_ID
				FROM
					hm_pub_role_source
				WHERE
					role_ID = #{staffId}
				AND company_id = #{companyId}
			) role
		LEFT JOIN (
			SELECT
				ID,
				SRCNAME,
				SRCIMG
			FROM
				hm_crm_source
			WHERE
				COMPANYID = #{companyId}
			AND (TYPEID = 1 OR TYPEID = 2)
		) sourse ON sourse.ID = role.SOURCE_ID
				LEFT JOIN (
					SELECT
						ID,
						SRCID,
						COSTTIME
					FROM
					hm_crm_cost cost
					WHERE
						FROM_UNIXTIME(cost.COSTTIME, '%Y/%m/%d ') LIKE CONCAT(
							"%",
							#{month}, "%")
						AND cost.companyId = #{companyId}
		GROUP BY SRCID,COSTTIME
		) a ON sourse.ID = a.SRCID


			UNION
				SELECT
					cost.ID COSTID,
					"" ID,
					"合计" SRCNAME,
					"NOIMG" SRCIMG,
					SUM(cost.COST) COST,
					cost.SRCID SRCID,
					FROM_UNIXTIME(cost.COSTTIME, '%Y/%m/%d ') COSTTIME,
					FROM_UNIXTIME(cost.COSTTIME, '%d ') COSTDATE,
					(
						SELECT
							SUM(b.COST)
						FROM
								hm_pub_role_source a


						LEFT JOIN hm_crm_cost b ON b.SRCID=a.source_id AND b.COMPANYID=a.company_id AND FROM_UNIXTIME(b.COSTTIME, '%Y/%m/%d ') LIKE CONCAT(
								"%",
								#{month}, "%") AND a.role_id=#{staffId}
						WHERE
							a.company_id=#{companyId}
							) TOTALCOST
						FROM
								hm_pub_role_source role


						LEFT JOIN hm_crm_cost cost ON cost.SRCID=role.source_id AND cost.COMPANYID=role.company_id AND FROM_UNIXTIME(cost.COSTTIME, '%Y/%m/%d ') LIKE CONCAT(
								"%",
								#{month}, "%") AND role.role_id=#{staffId}
						WHERE
								role.company_id=#{companyId}
							GROUP BY
								cost.COSTTIME
    </select>



    <insert id="insert" parameterType="com.qiein.jupiter.web.entity.po.CostPO" useGeneratedKeys="true" keyProperty="id">
        insert into hm_crm_cost(SRCID,COMPANYID,UPDATETIME,CREATETIME,COSTTIME,COST) values(#{srcId},#{companyId},UNIX_TIMESTAMP(now()),UNIX_TIMESTAMP(now()),UNIX_TIMESTAMP(#{costTime}),#{cost})
    </insert>
    <update id="editCost">
        update hm_crm_cost set cost=#{cost},UPDATETIME=UNIX_TIMESTAMP(now()) WHERE id=#{id}
    </update>

    <insert id="createCostLog">
        INSERT INTO hm_crm_cost_log (
            <include refid="costlog"/>
        )
        VALUES
            (#{costId}, #{operaId}, #{operaName},UNIX_TIMESTAMP(now()), #{companyId}, #{memo})
    </insert>
</mapper>