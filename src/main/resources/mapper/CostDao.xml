<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiein.jupiter.web.dao.CostDao">
    <resultMap id="Cost" type="com.qiein.jupiter.web.entity.vo.CostShowVO">
        <id column="ID" jdbcType="VARCHAR" property="id" />
        <result column="TOTALCOST" jdbcType="DECIMAL" property="totalCost"/>
        <result column="SRCID" jdbcType="INTEGER" property="srcId" />
        <result column="SRCNAME" jdbcType="VARCHAR" property="srcName" />
        <result column="SRCIMG" jdbcType="VARCHAR" property="srcImg" />
        <collection property="costPOS" ofType="com.qiein.jupiter.web.entity.po.CostPO">
            <result column="COST" jdbcType="DECIMAL" property="cost" />
            <result column="COSTTIME" jdbcType="VARCHAR" property="costTime" />
            <result column="COMPANYID" jdbcType="INTEGER" property="companyId" />
            <result column="COSTDATE" jdbcType="VARCHAR" property="date" />
        </collection>
    </resultMap>




  <select id="costList" resultMap="Cost">
         SELECT
            sourse.ID,
            SRCNAME,
            SRCIMG,
            (SELECT SUM(c.COST) FROM hm_crm_cost c WHERE c.COSTTIME=a.COSTTIME ) COST,
            SRCID,
            FROM_UNIXTIME(a.COSTTIME, '%Y/%m/%d') COSTTIME,
            FROM_UNIXTIME(a.COSTTIME, '%d ') COSTDATE,
            (
                SELECT
                    SUM(COST)
                FROM
                    hm_crm_cost b
                WHERE
                    a.SRCID = b.SRCID
                AND FROM_UNIXTIME(
                    b.COSTTIME,
                    '%Y/%m/%d '
                ) LIKE CONCAT("%", #{month}, "%")
                AND b.COMPANYID = #{companyId}
            ) TOTALCOST
        FROM
            hm_crm_source sourse
        LEFT JOIN (SELECT * from hm_crm_cost cost where FROM_UNIXTIME(
                    cost.COSTTIME,
                    '%Y/%m/%d '
                ) LIKE CONCAT("%", #{month}, "%") and cost.companyId=#{companyId}) a ON sourse.ID = a.SRCID
        WHERE


        sourse.COMPANYID = #{companyId}
        GROUP BY
            ID,
            COSTTIME
        UNION
            SELECT
                "",
                "合计",
                NULL,
                SUM(a.COST),
                NULL,
                FROM_UNIXTIME(a.COSTTIME, '%Y/%m/%d '),
                FROM_UNIXTIME(a.COSTTIME, '%d '),

                (
                    SELECT
                        SUM(COST)
                    FROM
                        hm_crm_cost
                    WHERE
                        FROM_UNIXTIME(COSTTIME, '%Y/%m/%d ') LIKE CONCAT("%", #{month}, "%") AND COMPANYID=#{companyId}
                )
            FROM
                hm_crm_cost a
            WHERE
                FROM_UNIXTIME(a.COSTTIME, '%Y/%m/%d ') LIKE CONCAT("%", #{month}, "%") AND a.COMPANYID=#{companyId}
            GROUP BY
                a.COSTTIME
    </select>

    <insert id="insert">
        insert into hm_crm_cost(SRCID,COMPANYID,UPDATETIME,CREATETIME,COSTTIME,COST) values(#{srcId},#{companyId},UNIX_TIMESTAMP(now()),UNIX_TIMESTAMP(now()),UNIX_TIMESTAMP(#{costTime}),#{cost})
    </insert>
    <update id="editCost">
        update hm_crm_cost set cost=#{cost},UPDATETIME=UNIX_TIMESTAMP(now()) WHERE COSTTIME=UNIX_TIMESTAMP(#{costTime})
    </update>
</mapper>